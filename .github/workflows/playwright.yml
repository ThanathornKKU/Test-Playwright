# à¹„à¸Ÿà¸¥à¹Œ: .github/workflows/playwright.yml
# GitHub Actions à¸ªà¸³à¸«à¸£à¸±à¸šà¸£à¸±à¸™ Playwright tests à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´

name: ğŸ­ Playwright Tests

# à¸à¸³à¸«à¸™à¸”à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸«à¸£à¹ˆà¹ƒà¸«à¹‰à¸£à¸±à¸™ workflow
on:
  # à¸£à¸±à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µ push à¹„à¸›à¸¢à¸±à¸‡ main branch
  push:
    branches: [ main, master ]
  
  # à¸£à¸±à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µ pull request à¹„à¸›à¸¢à¸±à¸‡ main branch
  pull_request:
    branches: [ main, master ]
  
  # à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰à¸£à¸±à¸™à¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡à¹ƒà¸™ GitHub UI
  workflow_dispatch:

# à¸à¸³à¸«à¸™à¸” jobs
jobs:
  test:
    # à¹ƒà¸Šà¹‰ Ubuntu runner à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
    runs-on: ubuntu-latest
    
    # à¸à¸³à¸«à¸™à¸” timeout à¹€à¸›à¹‡à¸™ 30 à¸™à¸²à¸—à¸µ
    timeout-minutes: 30
    
    steps:
      # 1. Checkout source code
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      # 2. Setup Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      # 4. Install Playwright browsers
      - name: ğŸ­ Install Playwright Browsers
        run: npx playwright install --with-deps
      
      # 5. Start HTTP server à¹ƒà¸™ background
      - name: ğŸŒ Start HTTP Server
        run: |
          # à¹€à¸£à¸´à¹ˆà¸¡ server à¹ƒà¸™ background
          npx http-server . -p 8080 -c-1 --silent &
          # à¸£à¸­à¹ƒà¸«à¹‰ server à¸à¸£à¹‰à¸­à¸¡ (à¸£à¸­ 10 à¸§à¸´à¸™à¸²à¸—à¸µ)
          sleep 10
          # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² server à¸—à¸³à¸‡à¸²à¸™
          curl --retry 5 --retry-delay 2 --retry-connrefused http://localhost:8080 || exit 1
          echo "âœ… Server is ready at http://localhost:8080"
      
      # 6. Run Playwright tests
      - name: ğŸ§ª Run Playwright Tests
        run: npx playwright test
        env:
          CI: true
      
      # 7. Upload test report à¸«à¸²à¸ tests à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§
      - name: ğŸ“Š Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      
      # 8. Upload test results à¸«à¸²à¸ tests à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§
      - name: ğŸ“‹ Upload Test Results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: test-results/
          retention-days: 7
      
      # 9. Comment à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹ƒà¸™ PR (à¹€à¸‰à¸à¸²à¸° pull request)
      - name: ğŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## ğŸ­ Playwright Test Results\n\n';
            
            // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸–à¸²à¸™à¸°à¸‚à¸­à¸‡ tests
            const success = '${{ job.status }}' === 'success';
            
            if (success) {
              comment += 'âœ… **All tests passed!** ğŸ‰\n\n';
              comment += '- âœ“ à¸«à¸™à¹‰à¸²à¸¥à¹‡à¸­à¸à¸­à¸´à¸™ tests\n';
              comment += '- âœ“ à¸—à¸”à¸ªà¸­à¸šà¸šà¸™ multiple browsers\n';
              comment += '- âœ“ Form validation tests\n\n';
            } else {
              comment += 'âŒ **Some tests failed** ğŸ˜\n\n';
              comment += 'ğŸ” [Check detailed logs here](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n';
              comment += 'ğŸ“Š [Download test report artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n';
            }
            
            comment += '---\n';
            comment += 'ğŸ¤– *Automated comment by GitHub Actions*\n';
            comment += `ğŸ“… *Run at: ${new Date().toLocaleString('th-TH')}*\n`;
            comment += `ğŸ”— *Commit: [\`${context.sha.substring(0, 7)}\`](https://github.com/${{ github.repository }}/commit/${context.sha})*`;
            
            // Create comment à¹ƒà¸™ PR
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job à¸ªà¸³à¸«à¸£à¸±à¸š security audit
  security:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout source code
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      # 2. Setup Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      # 4. Run security audit
      - name: ğŸ”’ Security Audit
        run: |
          echo "ğŸ” Running npm audit..."
          npm audit --audit-level moderate || echo "âš ï¸ Found some security issues"
          
          echo "ğŸ“¦ Checking for outdated packages..."
          npm outdated || echo "ğŸ“… Some packages are outdated"
        continue-on-error: true

  # Job à¸ªà¸³à¸«à¸£à¸±à¸š deploy (à¸£à¸±à¸™à¹€à¸‰à¸à¸²à¸°à¹€à¸¡à¸·à¹ˆà¸­ push à¹„à¸›à¸¢à¸±à¸‡ main à¹à¸¥à¸° tests à¸œà¹ˆà¸²à¸™)
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && success()
    
    steps:
      # 1. Checkout source code
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      # 2. Setup Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      # 4. Install Playwright browsers
      - name: ğŸ­ Install Playwright Browsers
        run: npx playwright install --with-deps
      
      # 5. Start server à¹à¸¥à¸° run tests à¹€à¸à¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡ report
      - name: ğŸ§ª Generate Test Report
        run: |
          npx http-server . -p 8080 -c-1 --silent &
          sleep 10
          npx playwright test || true  # à¹„à¸¡à¹ˆà¸«à¸¢à¸¸à¸”à¸–à¹‰à¸² tests fail
        env:
          CI: true
      
      # 6. Deploy to GitHub Pages
      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          exclude_assets: |
            node_modules
            .github
            test-results
            .gitignore
            package*.json
            playwright.config.ts
            tests
          destination_dir: ./
          
      # 7. Deploy test report
      - name: ğŸ“Š Deploy Test Report
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: playwright-report
          destination_dir: test-report
          keep_files: true